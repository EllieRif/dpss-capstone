---
title: "Extended Research"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# # Overview

The goal of this file is to have it be the source of truth for reading in variables. Any variable that edits those that came in here should be renamed in future files.  


# # Setup
#Libraries

```{r}
library(tidyverse)
library(readr)
library(sf)
library(broom)
library(lubridate)
library(stringr)

library(tidycensus)
library(sp)
library(jsonlite)
```

# Data Import

```{r}
case_data_counties <- read.csv("us-counties-rolling-cases.csv")

case_data_states <- read.csv("us-states-rolling.csv")

case_data_US <- read.csv("us-rolling-cases.csv")

mobility_2020 <-read.csv("2020_US_Region_Mobility_Report.csv")

mobility_2021 <- read.csv("2021_US_Region_Mobility_Report.csv")



```


```{r}
vars_dc_2019 <- load_variables(2019, "acs5")

#B01001_001

census_spatial <- get_acs(
  variables = "B01001_001",
  geography = "state",
  year = 2019,
  
  geometry = TRUE
  
)
```

# Data Cleaning - case data

Anything that doesn't create a new var name I want to happen in one place so that i dont double up
```{r}

#dates - cases
case_data_counties$date <- ymd(case_data_counties$date)
case_data_states$date <- ymd(case_data_states$date)
case_data_US$date <- ymd(case_data_US$date)

#fips - cases
case_data_states <- case_data_states %>% separate(geoid, into = c("geoid", "sfips"), sep = "-")
case_data_states$geoid <- NULL

case_data_counties <- case_data_counties %>% separate(geoid, into = c("geoid", "scfips"), sep = "-")
case_data_counties$geoid <- NULL






# state name
statename <- case_data_states %>% select(sfips, state) %>% distinct(sfips, state)






```


```{r}

#adjusting colnames to help joins

colnames(case_data_US)

colnames(case_data_US) <- paste("us_", colnames(case_data_US), sep = "")

colnames(case_data_states) <- paste("st_", colnames(case_data_states), sep = "")

colnames(case_data_counties) <- paste("co_", colnames(case_data_counties), sep = "")




```

#data cleaning - mobility

```{r}

all_mob <- bind_rows(mobility_2020, mobility_2021)

#date - mobility
all_mob$date <- ymd(all_mob$date)

us_mob <- all_mob %>% filter(sub_region_1 == "")

st_mob <- all_mob %>% filter(sub_region_1 != "", sub_region_2=="")  %>% distinct(sub_region_1, date, .keep_all = TRUE)

st_mob <- left_join(st_mob, statename, by = c("sub_region_1" = "state"))

co_mob <- all_mob %>% filter(sub_region_1 != "", sub_region_2!="")


```



# # Joins

#creating singular case data DF

I may work with US movement @ us caselevel, state movement at state caselevel, etc, but it's a lot of joins and creating a lot of DFs

may be able to work with summarize instead

```{r}


#creating DF that includes county and state level cases

sc_cases <- left_join(case_data_counties, case_data_states, by = c(c("co_state" = "st_state"), c("co_date" = "st_date")))

#sc_cases <- left_join(case_data_counties, case_data_states, by = c(c("co_state" = "st_state"), c("co_date" = "st_date")))


# adding in national data - only need to include date because it's the same for all states
all_cases <- left_join(sc_cases, case_data_US, by = c("co_date" = "us_date"))

#setting up fips for joins

co_mob$census_fips_code <- as.character(co_mob$census_fips_code)

co_mob$census_fips_code <- str_pad(co_mob$census_fips_code, 5, "left", "0")

# joining onto mobility data because case data does not include rows for 0 cases

county_cm <- left_join(co_mob, all_cases, by = c("date" = "co_date", "census_fips_code" = "co_scfips"))

county_cm <- county_cm %>% select(-metro_area, -iso_3166_2_code, -place_id, -co_county, -co_state, -us_geoid, -st_sfips, -country_region_code, -country_region) 

#grouping at high level rather than later
```
# # Updating joined data

# replacing NA with 0s for case numbers

```{r}


case_cols <- county_cm %>% select(co_cases:us_deaths_avg_per_100k) %>% colnames()

#test_narm <- county_cm



for (c in case_cols) {
  county_cm[[c]] <- replace_na(county_cm[[c]],0)
  
}

# Adding factoring before subsetting but after cleaning



#test_narm %>% group_by(date) %>% filter(year(date)==2021) %>% summarise(c=mean(us_cases))
#check on syntax for selecting with brackets and etc BUT IT WORKED


#replace_na(county_cm$co_cases,0)


```



# factoring risk groups
```{r}

county_cm <- county_cm %>%  mutate(
state_risk_group = case_when(
    st_cases_avg_per_100k>=0 & st_cases_avg_per_100k<=10 ~ 1,
    st_cases_avg_per_100k>10 & st_cases_avg_per_100k<=30 ~2,
    st_cases_avg_per_100k>30 & st_cases_avg_per_100k<=50 ~3,
    st_cases_avg_per_100k>50 & st_cases_avg_per_100k<=70 ~4,
    st_cases_avg_per_100k>70 & st_cases_avg_per_100k<=100 ~ 5,
    st_cases_avg_per_100k>100 & st_cases_avg_per_100k<=250 ~ 6,
    st_cases_avg_per_100k>250 ~ 7
    
  ),
national_risk_group = case_when(
    us_cases_avg_per_100k>=0 & us_cases_avg_per_100k<=10 ~ 1,
    us_cases_avg_per_100k>10 & us_cases_avg_per_100k<=30 ~2,
    us_cases_avg_per_100k>30 & us_cases_avg_per_100k<=50 ~3,
    us_cases_avg_per_100k>50 & us_cases_avg_per_100k<=70 ~4,
    us_cases_avg_per_100k>70 & us_cases_avg_per_100k<=100 ~ 5,
    us_cases_avg_per_100k>100 & us_cases_avg_per_100k<=250 ~ 6,
    us_cases_avg_per_100k>250 ~ 7

),

county_risk_group = case_when(
    co_cases_avg_per_100k>=0 & co_cases_avg_per_100k<=10 ~ 1,
    co_cases_avg_per_100k>10 & co_cases_avg_per_100k<=30 ~2,
    co_cases_avg_per_100k>30 & co_cases_avg_per_100k<=50 ~3,
    co_cases_avg_per_100k>50 & co_cases_avg_per_100k<=70 ~4,
    co_cases_avg_per_100k>70 & co_cases_avg_per_100k<=100 ~ 5,
    co_cases_avg_per_100k>100 & co_cases_avg_per_100k<=250 ~ 6,
    co_cases_avg_per_100k>250 ~ 7

) )

```








# data cleaning - joining and factoring further data

relevant factors: is an order in place? is a mask mandate in place? is it summer? is it holiday season? voting and svi data

```{r}

vax_data <- read_csv("county_week26_data_fixed.csv")

vote_data <- read_csv("vote2020.csv")

vax_data$`FIPS Code` <- str_pad(vax_data$`FIPS Code`, 5, "left", "0")

vote_data$county_fips <- str_pad(vote_data$county_fips, 5, "left", "0")

vax_data <- vax_data %>% select(-State, -`County Name`)

vax_vote <- left_join(vote_data, vax_data, by = c("county_fips" = "FIPS Code"))

cm_vax_vote <- left_join(county_cm, vax_vote, by = c("census_fips_code" = "county_fips"))

#keeping it from being too many vars to work with for right now, selecting avgs

cmvv_avg100k <- cm_vax_vote %>%  select(sub_region_1: residential_percent_change_from_baseline, co_cases_avg_per_100k, st_cases_avg_per_100k, us_cases_avg_per_100k, state_risk_group:county_risk_group, votes_gop: `Percent non-Hispanic White`)

# adding factored vars for svi and CVAC, gop win, and majority minority

cmvv_avg100k <- cmvv_avg100k %>%  mutate(gop_win = ifelse(per_gop>0.5,1,0), maj_minority = ifelse(`Percent non-Hispanic White`<50, 1, 0), svi_fac = factor(`SVI Category`, levels = c("Very Low Vulnerability", "Low Vulnerability", "Moderate Vulnerability", "High Vulnerability", "Very High Vulnerability"), ordered = TRUE), cvac_fac = factor(`CVAC Category`, levels = c("Very Low Vulnerability", "Low Vulnerability", "Moderate Vulnerability", "High Vulnerability", "Very High Vulnerability"), ordered = TRUE))
```



# clean colnames

```{r}
cmvv_avg100k <- cmvv_avg100k %>% rename(
  svi = `Social Vulnerability Index (SVI)`,
  svi_cat = `SVI Category`,
cvac =  `Ability to handle a COVID-19 outbreak (CVAC)`,
  cvac_cat = `CVAC Category`,
  retail_rec_pctchange = retail_and_recreation_percent_change_from_baseline,
  grocery_pharma_pctchange = grocery_and_pharmacy_percent_change_from_baseline,
  parks_pctchange = parks_percent_change_from_baseline,
  transit_pctchange = transit_stations_percent_change_from_baseline ,
  work_pctchange = workplaces_percent_change_from_baseline,
  residential_pctchange = residential_percent_change_from_baseline,
  pct_hisp = `Percent Hispanic`,
  pct_native = `Percent non-Hispanic American Indian/Alaska Native`,
   pct_asian = `Percent non-Hispanic Asian`,
pct_black = `Percent non-Hispanic Black`,
  pct_pi =`Percent non-Hispanic Native Hawaiian/Pacific Islander`,
   pct_white = `Percent non-Hispanic White`
  
)

#adding holiday dummy variable
cmvv_avg100k <- cmvv_avg100k %>% mutate(holiday = ifelse(month(date)==11 | month(date)==12, 1, 0))
```


a SUPER cool visualization to try would be if i used a for loop to run regressions for every state and then used that as its own DF for geospatial data. I could totally do it



