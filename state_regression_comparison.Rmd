---
title: "state_comparative_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



Goal: a SUPER cool visualization to try would be if i used a for loop to run regressions for every state and then used that as its own DF for geospatial data. I could totally do it

# libraries
```{r}
library(tidyverse)
library(readr)
library(sf)

library(broom)
library(lubridate)
```

# # Case Numbers
What regressions do I want to run?

cases -> only national (factored and unfactored)

cases -> only state (factored and unfactored)

cases -> only county (factored and unfactored)

cases -> all three together

controls:
svi - factored and unfactored
cvac - factored and unfactored
per_gop
race
gop_win
Majority minority

I should definitely write a function here
 we need to simplify
 
 all three factored
 
 all three unfactored
 
 gop
 svi
 cvac
 race


# All State


```{r}



#define function all state cases as opposed to by state cases

all_state_cases <- function(dep_var) {
 # create a df with single var that includes variable names for any regressions I'd run
  
  
  full_reg <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

  full_reg = tidy(full_reg)
  
  rgrsrs <- data.frame(
    
    term = full_reg$term
  )
  
# rgrsrs <- data.frame(
#   term = c(colnames(cmvv_avg100k)[11:16], colnames(cmvv_avg100k)[21],colnames(cmvv_avg100k)[24], colnames(cmvv_avg100k)[26], colnames(cmvv_avg100k)[31:35], colnames(cmvv_avg100k)[41]), "per_gop:`Estimated hesitant`") 

#dep_var <- cmvv_avg100k[[dep_var]]


  # regress only national cases(factored and unfactored)


reg1 <- lm(dep_var~us_cases_avg_per_100k, data = cmvv_avg100k)

reg1 <- tidy(reg1)

colnames(reg1)[2:5] <- paste("reg1", colnames(reg1)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg1, by ="term")


#state only
reg2 <- lm(dep_var~st_cases_avg_per_100k, data = cmvv_avg100k)

reg2 <- tidy(reg2)

colnames(reg2)[2:5] <- paste("reg2", colnames(reg2)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg2, by ="term")


#county only
reg3 <- lm(dep_var~co_cases_avg_per_100k, data = cmvv_avg100k)

reg3 <- tidy(reg3)

colnames(reg3)[2:5] <- paste("reg3", colnames(reg3)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg3, by ="term")

#all three

reg4 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k, data = cmvv_avg100k)

reg4 <- tidy(reg4)

colnames(reg4)[2:5] <- paste("reg4", colnames(reg4)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg4, by ="term")

#add in GOP

reg5 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + per_gop, data = cmvv_avg100k)

reg5 <- tidy(reg5)

colnames(reg5)[2:5] <- paste("reg5", colnames(reg5)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg5, by ="term")



# add in SVI

reg6 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + per_gop + svi, data = cmvv_avg100k)

reg6 <- tidy(reg6)

colnames(reg6)[2:5] <- paste("reg6", colnames(reg6)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg6, by ="term")


#adding in race

reg7 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi, data = cmvv_avg100k)

reg7 <- tidy(reg7)

colnames(reg7)[2:5] <- paste("reg7", colnames(reg7)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg7, by ="term")



reg8 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

reg8 <- tidy(reg8)

colnames(reg8)[2:5] <- paste("reg8", colnames(reg8)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg8, by ="term")

# add estimated hesitant and interaction term

reg9 <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

reg9 <- tidy(reg9)

colnames(reg9)[2:5] <- paste("reg9", colnames(reg9)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg9, by ="term")

return(rgrsrs)

}


```






# by state

```{r}


by_state_cases <- function(dep_var) {
  
  full_reg <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)
  
  full_reg = tidy(full_reg)
  
  rgrsrs <- data.frame(
    
    term = full_reg$term
  )
  

  # rgrsrs <- data.frame(
  # ind_vars = c(colnames(cmvv_avg100k)[11:13], colnames(cmvv_avg100k)[21], colnames(cmvv_avg100k)[24], colnames(cmvv_avg100k)[26], colnames(cmvv_avg100k)[31:35], colnames(cmvv_avg100k)[41], "per_gop:`Estimated hesitant`"))




sn <- statename %>% filter(state %in% cmvv_avg100k$sub_region_1, state!="Alaska", state!="Hawaii") %>% arrange(state)

sn <- sn$state

#print(rgrsrs$ind_vars[1:15])

#print(rgrsrs$ind_vars)

#missingness with alaska
#sn <- sort(sn) %>% filter(sn %in% cmvv_avg100k$sub_region_1)

for (s in sn) {
  
  dep_df <-data.frame(
    dep_var = c(dep_var)
    
  )
  
  temp_df <- bind_cols(cmvv_avg100k, dep_df)
  
  #print(colnames(temp_df))
  
  temp_df <- temp_df %>% filter(sub_region_1==s) %>% select(dep_var, 11:13, 21,24,26,31:35,41) %>% drop_na()
  #print(s)
  
  #new_dep <- temp_df[[dep_var]]
  
  #print(dep_var)
  
  #temp_df$sub_region_1
  
  c_name <- paste("coeff", s, sep = "_")
  p_name <- paste("pval", s, sep = "_")
  print(c_name)
  
  temp_reg <- lm(dep_var~us_cases_avg_per_100k + st_cases_avg_per_100k + co_cases_avg_per_100k + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = temp_df)
  
  temp_reg <- tidy(temp_reg)
  
  rgrsrs[[c_name]] <- temp_reg$estimate
  rgrsrs[[p_name]] <- temp_reg$p.value
  #state_results <- state_results %>% mutate(c_name = temp_reg$estimate, p_name <-temp_reg$p.value)
  
  
}

long_results <- rgrsrs %>%  pivot_longer(cols = c(coeff_Alabama:pval_Wyoming), names_to = c("est_pval", "state"), names_sep = "_")

wide_results <- long_results %>% pivot_wider(names_from = term, values_from = value)

return(wide_results)
}

```






#rejoining geospatial data

```{r}
# adding fips back in
#have to limit to just coeffs first

gp_state_coeffs <- left_join(gp_state_coeffs, statename)

gp_state_coeffs <- gp_state_coeffs %>% rename(intercept = `(Intercept)`)

gp_state_geo_coeffs <- right_join(census_spatial, gp_state_coeffs, by = c("GEOID"="sfips"))
```


```{r}
x <- cmvv_avg100k$grocery_pharma_pctchange
```


# # risk groups

#all state

```{r}



#define function all state cases as opposed to by state cases

all_state_risk <- function(dep_var) {
 # create a df with single var that includes variable names for any regressions I'd run
  
  
  full_reg <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

  full_reg = tidy(full_reg)
  
  rgrsrs <- data.frame(
    
    term = full_reg$term
  )
  
# rgrsrs <- data.frame(
#   term = c(colnames(cmvv_avg100k)[11:16], colnames(cmvv_avg100k)[21],colnames(cmvv_avg100k)[24], colnames(cmvv_avg100k)[26], colnames(cmvv_avg100k)[31:35], colnames(cmvv_avg100k)[41]), "per_gop:`Estimated hesitant`") 

#dep_var <- cmvv_avg100k[[dep_var]]


  # regress only national cases(factored and unfactored)


reg1 <- lm(dep_var~national_risk_group, data = cmvv_avg100k)

reg1 <- tidy(reg1)

colnames(reg1)[2:5] <- paste("reg1", colnames(reg1)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg1, by ="term")


#state only
reg2 <- lm(dep_var~state_risk_group, data = cmvv_avg100k)

reg2 <- tidy(reg2)

colnames(reg2)[2:5] <- paste("reg2", colnames(reg2)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg2, by ="term")


#county only
reg3 <- lm(dep_var~county_risk_group, data = cmvv_avg100k)

reg3 <- tidy(reg3)

colnames(reg3)[2:5] <- paste("reg3", colnames(reg3)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg3, by ="term")

#all three

reg4 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group, data = cmvv_avg100k)

reg4 <- tidy(reg4)

colnames(reg4)[2:5] <- paste("reg4", colnames(reg4)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg4, by ="term")

#add in GOP

reg5 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + per_gop, data = cmvv_avg100k)

reg5 <- tidy(reg5)

colnames(reg5)[2:5] <- paste("reg5", colnames(reg5)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg5, by ="term")



# add in SVI

reg6 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + per_gop + svi, data = cmvv_avg100k)

reg6 <- tidy(reg6)

colnames(reg6)[2:5] <- paste("reg6", colnames(reg6)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg6, by ="term")


#adding in race

reg7 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi, data = cmvv_avg100k)

reg7 <- tidy(reg7)

colnames(reg7)[2:5] <- paste("reg7", colnames(reg7)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg7, by ="term")



reg8 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

reg8 <- tidy(reg8)

colnames(reg8)[2:5] <- paste("reg8", colnames(reg8)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg8, by ="term")

# add estimated hesitant and interaction term

reg9 <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)

reg9 <- tidy(reg9)

colnames(reg9)[2:5] <- paste("reg9", colnames(reg9)[2:5], sep = "")

rgrsrs<-left_join(rgrsrs, reg9, by ="term")

return(rgrsrs)

}


```


# by state

```{r}


by_state_risk <- function(dep_var) {
  
  full_reg <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = cmvv_avg100k)
  
  full_reg = tidy(full_reg)
  
  rgrsrs <- data.frame(
    
    term = full_reg$term
  )
  

  # rgrsrs <- data.frame(
  # ind_vars = c(colnames(cmvv_avg100k)[11:13], colnames(cmvv_avg100k)[21], colnames(cmvv_avg100k)[24], colnames(cmvv_avg100k)[26], colnames(cmvv_avg100k)[31:35], colnames(cmvv_avg100k)[41], "per_gop:`Estimated hesitant`"))




sn <- statename %>% filter(state %in% cmvv_avg100k$sub_region_1, state!="Alaska", state!="Hawaii") %>% arrange(state)

sn <- sn$state

#print(rgrsrs$ind_vars[1:15])

#print(rgrsrs$ind_vars)

#missingness with alaska
#sn <- sort(sn) %>% filter(sn %in% cmvv_avg100k$sub_region_1)

for (s in sn) {
  
  dep_df <-data.frame(
    dep_var = c(dep_var)
    
  )
  
  temp_df <- bind_cols(cmvv_avg100k, dep_df)
  
  #print(colnames(temp_df))
  
  temp_df <- temp_df %>% filter(sub_region_1==s) %>% select(dep_var, 14:16, 21,24,26,31:35,41) %>% drop_na()
  #print(s)
  
  #new_dep <- temp_df[[dep_var]]
  
  #print(dep_var)
  
  #temp_df$sub_region_1
  
  c_name <- paste("coeff", s, sep = "_")
  p_name <- paste("pval", s, sep = "_")

  temp_reg <- lm(dep_var~national_risk_group + state_risk_group + county_risk_group + `Estimated hesitant`* per_gop + svi + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = temp_df)
  
  temp_reg <- tidy(temp_reg)
  
  rgrsrs[[c_name]] <- temp_reg$estimate
  rgrsrs[[p_name]] <- temp_reg$p.value
  #state_results <- state_results %>% mutate(c_name = temp_reg$estimate, p_name <-temp_reg$p.value)
  
  
}

long_results <- rgrsrs %>%  pivot_longer(cols = c(coeff_Alabama:pval_Wyoming), names_to = c("est_pval", "state"), names_sep = "_")

wide_results <- long_results %>% pivot_wider(names_from = term, values_from = value)

return(wide_results)
}

```