---
title: "state_comparative_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


Goal: a SUPER cool visualization to try would be if i used a for loop to run regressions for every state and then used that as its own DF for geospatial data. I could totally do it

# libraries
```{r}
library(tidyverse)
library(readr)
library(sf)

library(broom)
library(lubridate)
```

# # Steps to visualization - Retail and Rec



# debug 2
```{r}




rr_state_results <- data.frame(
  term = all_state8$term
)

sn <- statename %>% filter(state %in% cmvv_avg100k$sub_region_1, state!="Alaska", state!="Hawaii") %>% arrange(state)

sn <- sn$state

rr_adjrsq <- numeric(0)


#missingness with alaska
#sn <- sort(sn) %>% filter(sn %in% cmvv_avg100k$sub_region_1)

for (s in sn) {
  temp_df <- cmvv_avg100k %>% filter(sub_region_1==s) %>% select(retail_rec_pctchange, national_risk_group, state_risk_group, county_risk_group, svi, cvac, per_gop, `Estimated hesitant`, pct_black, pct_hisp, pct_asian, pct_native, pct_pi, holiday) %>% drop_na()
  #print(s)
  
  temp_df$sub_region_1
  
  c_name <- paste("coeff", s, sep = "_")
  p_name <- paste("pval", s, sep = "_")

  temp_reg <- lm(retail_rec_pctchange~national_risk_group + state_risk_group + county_risk_group + svi + cvac + per_gop*`Estimated hesitant` + pct_black + pct_hisp + pct_asian + pct_native + pct_pi + holiday, data = temp_df)
  #adding in rsq
  
  temp_rsq <- summary(temp_reg)$adj.r.squared
  
  #print(temp_rsq)
  rr_adjrsq <-c(rr_adjrsq, temp_rsq)
  
  temp_reg <- tidy(temp_reg)
  
  rr_state_results[[c_name]] <- temp_reg$estimate
  rr_state_results[[p_name]] <- temp_reg$p.value
  #state_results <- state_results %>% mutate(c_name = temp_reg$estimate, p_name <-temp_reg$p.value)
  
  
}


```
# pivoting df

```{r}
rr_long_state_results <- rr_state_results %>% pivot_longer(cols = c(coeff_Alabama:pval_Wyoming), names_to = c("est_pval", "state"), names_sep = "_")

rr_wide_state_results <- rr_long_state_results %>% pivot_wider(names_from = term, values_from = value)

rr_state_coeffs <- rr_wide_state_results %>% filter(est_pval=="coeff")
```


taking out ntile methodology in favor of outlier methodology




#rejoining geospatial data

```{r}
# adding fips back in

rr_state_coeffs <- left_join(rr_state_coeffs, statename)

rr_state_coeffs <- rr_state_coeffs %>% rename(intercept = `(Intercept)`)

rr_state_geo_coeffs <- right_join(census_spatial, rr_state_coeffs, by = c("GEOID"="sfips"))

rr_state_adjrsq <- data_frame(
  state = sn,
  adj.r.squared = rr_adjrsq
  
)

rr_state_geo_coeffs <- left_join(rr_state_geo_coeffs, rr_state_adjrsq, by = "state")
```

# geospatial charts -- intercept

```{r}
rr_state_geo_coeffs %>%  ggplot() + 
  geom_sf(mapping = aes(fill = intercept/100)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change")
```


```{r}
rr_state_geo_coeffs %>%  ggplot() + 
  geom_sf(mapping = aes(fill = national_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "RR - Responsiveness to National Level Cases")


rr_state_geo_coeffs %>%  ggplot() + 
  geom_sf(mapping = aes(fill = state_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "RR - Responsiveness to State Level Cases")

rr_state_geo_coeffs %>%  ggplot() + 
  geom_sf(mapping = aes(fill = county_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "RR- Responsiveness to County Level Cases")
```



# outliers methodology

more effective than ntile
note: define regression in the thingie
```{r}
us_outliers<-boxplot(rr_state_coeffs$national_risk_group)$out
st_outliers<-boxplot(rr_state_coeffs$state_risk_group)$out
co_outliers<-boxplot(rr_state_coeffs$county_risk_group)$out

rr_cplot_rmout <- rr_state_geo_coeffs %>% filter(!(county_risk_group %in% co_outliers)) %>% ggplot() + geom_sf(mapping = aes(fill = county_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "RR - Responsiveness to County Level Cases")

co_out_pos <- co_outliers>=0

co_out_neg<- co_outliers<0

co_outliers[co_out_pos]
co_outliers[co_out_neg]
rr_cplot_out_pos <- rr_state_geo_coeffs %>% filter(county_risk_group %in% co_outliers[co_out_pos]) %>%  geom_sf(mapping = aes(), fill = "white")

rr_cplot_out_neg <- rr_state_geo_coeffs %>% filter(county_risk_group %in% co_outliers[co_out_neg]) %>%  geom_sf(mapping = aes(), fill = "purple")


rr_cplot_rmout + rr_cplot_out_pos + rr_cplot_out_neg

```
```{r}
rr_splot_rmout <- rr_state_geo_coeffs %>% filter(!(state_risk_group %in% st_outliers)) %>% ggplot() + geom_sf(mapping = aes(fill = state_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "rr - Responsiveness to State Level Cases")

st_out_pos <- st_outliers>=0

st_out_neg<- st_outliers<0

st_outliers[st_out_pos]
st_outliers[st_out_neg]


rr_splot_out_pos <- rr_state_geo_coeffs %>% filter(state_risk_group %in% st_outliers[st_out_pos]) %>%  geom_sf(mapping = aes(), fill = "pink")

rr_splot_out_neg <- rr_state_geo_coeffs %>% filter(state_risk_group %in% st_outliers[st_out_neg]) %>%  geom_sf(mapping = aes(), fill = "purple")


rr_splot_rmout + rr_splot_out_pos + rr_splot_out_neg
```
```{r}
rr_nplot_rmout <- rr_state_geo_coeffs %>% filter(!(national_risk_group %in% us_outliers)) %>% ggplot() + geom_sf(mapping = aes(fill = national_risk_group)) + scale_fill_distiller(palette = "YlOrRd", name = "Average Traffic Change") + labs(title = "rr - Responsiveness to National Level Cases")

us_out_pos <- us_outliers>=0

us_out_neg<- us_outliers<0

us_outliers[us_out_pos]
us_outliers[us_out_neg]


rr_nplot_out_pos <- rr_state_geo_coeffs %>% filter(national_risk_group %in% us_outliers[us_out_pos]) %>%  geom_sf(mapping = aes(), fill = "pink")

rr_nplot_out_neg <- rr_state_geo_coeffs %>% filter(national_risk_group %in% us_outliers[us_out_neg]) %>%  geom_sf(mapping = aes(), fill = "purple")


rr_nplot_rmout + rr_nplot_out_pos + rr_nplot_out_neg
```



# # charts with equal scale